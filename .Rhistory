# Format
temp <- matrix(NA, nrow = max.sites, ncol = nyrs)
rownames(temp) <- all.sites
colnames(temp) <- yrs
# Add temper for fields with counts > 0
for (i in 1:nrow(sp)){
temp[which(rownames(temp) %in% sp$transectID[i]), which(colnames(temp) %in% sp$Year[i])] <- sp$Temp[i]
}
# Add temper for fields with absences (0)
for (i in 1:nrow(absent)){
temp[which(rownames(temp) %in% absent$transectID[i]), which(colnames(temp) %in% absent$Year[i])] <- absent$Temp[i]
}
# ---- Specify data in JAGS format ----
# Distance class and ind
nind <- nrow(sp)
dclass <- sp$Banda
m  # Counts per year and site
# Co-variates
yrs <- 1:9
year_number <- 0:8
# Matrix with observers
ob <- matrix(as.numeric(factor(obs)), nrow = max.sites, ncol = nyrs) # JAGS doesn't accept categorical variables
unique(factor(ob))
obs_id <- unique(factor(ob))[-1]
ob[which(is.na(ob))] <- sample(obs_id, length(which(is.na(ob))), replace = TRUE) # No NA in covariate
nobs <- length(unique(factor(ob)))
# Matrix with temperature (put random values where NA)
unique(factor(temp))
temp_id <- unique(factor(temp))[-1]
temp[which(is.na(temp))] <- sample(temp_id, length(which(is.na(temp))), replace = TRUE) # No NA in covariate
#temp_mean <- mean(temp)
#temp_sd <- sd(temp)
#temp_sc <- (temp - temp_mean) / temp_sd
# Index for random effects
site <- c(1:max.sites)
year <- c(1:nyrs)
sitesYears <- NULL
for (i in 1:nyrs){
sitesYears <- c(sitesYears,c(1:length(all.sites)))}
# Fixed index to map dclass onto site and year
# For the index, create a matrix m where NA are 0 (because I need the same length)
m_index <- m
m_index[which(is.na(m_index))] <- 0
site.dclass <- year.dclass <- NULL
for (t in 1:nyrs){ # sites has to be nested on years because dclass first indexes the sites on the same year
for (j in 1:max.sites){
site.dclass <- c(site.dclass, rep(j, m_index[j,t]))
year.dclass <- c(year.dclass, rep(t, m_index[j,t]))
} }
###################################################################
##                       TRIM ANALYSIS                          ###
###################################################################
# ---- Subset for trim analysis ----
sp <- all_sp[, which(colnames(all_sp) %in% c("Year", "transectID", "count"))] # Select species MECAL and all years
colnames(sp)[which(colnames(sp) %in% "transectID")] <- "site"
colnames(sp)[which(colnames(sp) %in% "Year")] <- "year"
sp$year <- as.integer(sp$year)
g <- aggregate(count ~ year, FUN = sum, data = sp)
sp <- aggregate(count ~ year + site, FUN = sum, data = sp)
check_observations(sp, model = 2)
# ---- MODEL 3 ----
m3 <- trim(count ~ site + year, data = sp, model = 3)
i3 <- index(m3, which="both")
#Extract the coefficients
coef <- coefficients(m3, representation = c("trend"))
sig_dev <- wald(m3)
sig <- overall(m3) # The p-value of this is the significant value for the overall trend in m3, = p value of the slope of m2 with all change points
table$p_wald[xxx] <- sig$slope$p
}
table[,c(3,4,5,7,8,9)] <- round(table[,c(3,4,5,7,8,9)] , digits = 3)
table[,c(10)] <- round(table[,c(10)] , digits = 3)
setwd("S:/PhD/Second chapter/Data/Results/Paper")
